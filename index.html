<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>丐版课程表</title>
    <style type="text/css">
      table {
        border-spacing: 0;
        border-collapse: collapse;
        box-sizing: border-box;
        text-indent: 0;
        margin: 0;
        padding: 0;
      }
      tbody {
        border-top: 1px solid black;
        border-left: 1px solid black;
      }
      tr {
        border-spacing: 0;
        height: 6em;
        min-height: 6em;
      }
      td {
        border-right: 1px solid black;
        border-bottom: 1px solid black;
        padding: 8px;
        max-width: 8em;
        width: 8em;
        overflow-y: scroll;
        white-space: pre-wrap;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <form>
      <select name="academy" id="academy"></select>
      <select name="major" id="major"></select>
      <select name="class" id="class"></select>
    </form>
    <pre>
    <table>
      <tbody>
        <tr key="1">
          <td key="1"></td>
          <td key="2"></td>
          <td key="3"></td>
          <td key="4"></td>
          <td key="5"></td>
          <td key="6"></td>
          <td key="7"></td>
        </tr>
        <tr key="2">
          <td key="1"></td>
          <td key="2"></td>
          <td key="3"></td>
          <td key="4"></td>
          <td key="5"></td>
          <td key="6"></td>
          <td key="7"></td>
        </tr>
        <tr key="3">
          <td key="1"></td>
          <td key="2"></td>
          <td key="3"></td>
          <td key="4"></td>
          <td key="5"></td>
          <td key="6"></td>
          <td key="7"></td>
        </tr>
        <tr key="4">
          <td key="1"></td>
          <td key="2"></td>
          <td key="3"></td>
          <td key="4"></td>
          <td key="5"></td>
          <td key="6"></td>
          <td key="7"></td>
        </tr>
        <tr key="5">
          <td key="1"></td>
          <td key="2"></td>
          <td key="3"></td>
          <td key="4"></td>
          <td key="5"></td>
          <td key="6"></td>
          <td key="7"></td>
        </tr>
      </tbody>
    </table>
    </pre>
    <pre id="debug"></pre>
    <script>
      (function (w, d, $, u) {
        var clear = function clear() {
          Array.prototype.forEach.call($("tbody").children, function (tr) {
            Array.prototype.forEach.call(tr.children, function (td) {
              td.innerHTML = "";
            });
          });
        };
        var append = function append(row, col, text) {
          $(
            "tbody > tr[key='" + row + "'] > td[key='" + col + "']"
          ).innerHTML += text;
        };
        var generateTable = function generateTable() {
          clear();
          fetch("tables/" + $("#class").value + ".json")
            .then(function (res) {
              return res.json();
            })
            .then(function (list) {
              list[0].forEach(function (item) {
                var day = item.id.skxq;
                var time = Math.floor(item.id.skjc / 2) + 1;
                var week = item.zcsm;
                var name = item.kcm;
                var teacher = item.jsm;
                var location = item.xqm + item.jxlm + item.jash;
                var last = item.cxjc / 2;
                if (last == 2) {
                  append(
                    time,
                    day,
                    [name, teacher, week, location].join("\n") + "\n\n"
                  );
                  append(
                    time + 1,
                    day,
                    [name, teacher, week, location].join("\n") + "\n\n"
                  );
                } else if (last == 1) {
                  append(
                    time,
                    day,
                    [name, teacher, week, location].join("\n") + "\n\n"
                  );
                }
              });
            });
        };
        var switchClasses = function switchClasses() {
          $("#class").innerHTML = "";
          fetch($("#academy").value + "/" + $("#major").value + ".csv")
            .then(function (res) {
              return res.text();
            })
            .then(function (text) {
              $("#debug").innerHTML = text;
              text
                .replace(/\\r/g, "")
                .split("\n")
                .forEach(function (line) {
                  if (line == "") return;
                  var option = document.createElement("option");
                  option.innerHTML = line.split(",")[3];
                  option.value = line.split(",")[3];
                  $("#class").appendChild(option);
                });
            });
        };
        var switchMajors = function switchMajors() {
          fetch($("#academy").value + "/index.txt")
            .then(function (res) {
              return res.text();
            })
            .then(function (text) {
              $("#major").innerHTML = "";
              text
                .replace(/\\r/g, "")
                .replace(/\.csv/g, "")
                .split("\n")
                .forEach(function (line) {
                  if (line == "") return;
                  var option = document.createElement("option");
                  option.innerHTML = line;
                  option.value = line;
                  $("#major").appendChild(option);
                });
            });
        };
        window.onload = function () {
          $("#academy").onclick = switchMajors;
          $("#major").onclick = switchClasses;
          $("#class").onclick = generateTable;
          fetch("academy.txt")
            .then(function (res) {
              return res.text();
            })
            .then(function (text) {
              $("#academy").innerHTML = "";
              text.split("\n").forEach(function (line) {
                if (line == "") return;
                var option = document.createElement("option");
                option.innerHTML = line;
                option.value = line;
                $("#academy").appendChild(option);
              });
            });
        };
      })(window, document, function (str) {
        return document.querySelector(str);
      });
    </script>
  </body>
</html>
